/**
 * LibPLUS
 * Version: 2.0 - 12.01.2017
 * Author: Dawid Stankiewicz
 * theszczypiorek[ at ]gmail.com
 * github.com/DawidStankiewicz
 *
 * Export user's data thanks to ExcelPlus: http://aymkdn.github.io/ExcelPlus/
 */
function Grade(a,b,c,d,e,f,g,h,i,j,k){this.id=a,this.type=b,this.rawData=c,this.rawVal=d,this.val=e,this.subject=f,this.category=g,this.date=h,this.weight=i,this.teacher=j,this.addedBy=k}function Subject(a,b,c,d){this.id=a,this.name=b,this.avg=c,this.numberOfGrades=d}function User(a,b,c){this.name=a,this.grades=b,this.subjects=c}function getUserWithData(){let a=new User;return a.name=findUserName(),a.grades=findAllGrades(),a.subjects=getAllSubjects(a.grades),a}function findUserName(){return $('b:contains("Uczeń:")').parent().text().replace("Uczeń: ","").replace("Klasa:","")}function main(){isAllGradeMode()&&(a=getUserWithData(),createContainers(),calculateAndDisplayAvg(),setNumberOfGradesOnPage(countGrades()),createButtons())}function createContainers(){createLibPLUSContainer(),$("#"+LIBPLUS_ID).append(STUDENT_AVG_CONTAINER),$("#"+LIBPLUS_ID).append(STUDENT_AVG_END_FIRST_CONTAINER),$("#"+LIBPLUS_ID).append(STUDENT_GRADE_COUNTER_CONTAINER),createContainersOfSubjects(),createFormForUserAvgOfDateRage(),createContainerForUserAvgOfDateRage()}function createLibPLUSContainer(){$(".container-icon").after("<div id="+LIBPLUS_ID+' class="container"></div>')}function createContainersOfSubjects(){a.subjects.forEach(function(a){$("#przedmioty_"+a.id).prev().children("td:nth-child(4)").after().html(" "),$("#przedmioty_"+a.id).prev().children("td:nth-child(4)").after().append('<span title="Średnia wyświetlona dzięki rozszerzeniu LibPLUS." id="avgSubject_'+a.id+'"></span>')})}function createContainerForUserAvgOfDateRage(){$("#"+LIBPLUS_ID).append(STUDENT_AVG_DATE_RAGE_CONTAINER)}function setAvgValueOfUserOnPage(a){$("#"+STUDENT_AVG_CONTAINER_ID).text(a)}function setNumberOfGradesOnPage(a){$("#"+STUDENT_GRADE_COUNTER_CONTAINER_ID).text(a)}function setAvgValueOfSubjectOnPage(a){a.forEach(function(a){$("#avgSubject_"+a.id).text(roundDecimalPlaces(a.avg))})}function setAvgValueOfEndFirstPeriodOnPage(a){$("#"+STUDENT_AVG_END_FIRST_CONTAINER_ID).text(a)}function setAvgValueOfDateRangeOnPage(a){$("#"+STUDENT_AVG_DATE_RAGE_CONTAINER_ID).text(roundDecimalPlaces(a))}function displayGradesAndAvg(a){hideAllGrades(),a.forEach(function(a){showGradeOnPage(a.id),0!=a.weight&&showSubjectAvgContainer(getGradeSubject(a.id))})}function hideAllGrades(){a.grades.forEach(function(a){hideGradeOnPage(a.id),hideSubjectAvgContainer(getGradeSubject(a.id))})}function hideGradeOnPage(a){$(GRADE_ID+a).hide()}function showGradeOnPage(a){$(GRADE_ID+a).show()}function hideSubjectAvgContainer(a){$("#avgSubject_"+a.id).hide()}function showSubjectAvgContainer(a){$("#avgSubject_"+a.id).show()}function calculateAndDisplayAvg(){setAvgValueOfUserOnPage(roundDecimalPlaces(getCalculatedAvg(a.grades))),setAvgValueOfSubjectOnPage(a.subjects),setAvgValueOfEndFirstPeriodOnPage(roundDecimalPlaces(getCalculatedAvg(getGradesEndOfFirstPeriod(a.grades))))}function getCalculatedAvg(a){let b=0,c=0,d=0,e=0;return a.forEach(function(a){let b=Number(a.val),f=Number(a.weight);0!=f&&(d+=b*f,e+=f,c++,DEBUG_AVG_CALCULATE&&(console.log("id: "+a.id),console.log("type : "+a.type),console.log("grade val: "+b),console.log("subject: "+a.subject),console.log("weight: "+f),console.log("counter:  "+c),console.log("avg: "+d/e),console.log("\n\n\n")))}),b=d/e}function getAvgOfSubject(a,b){let c=new Array,d=0;return b.forEach(function(b){0===b.subject.localeCompare(a)&&(c[d]=b,d++)}),getCalculatedAvg(c)}function getGradesEndOfFirstPeriod(a){let b=new Array,c=0;return a.forEach(function(a){if(GRADE_END_FIRST===a.type){let d=jQuery.extend({},a);d.weight=1,b[c]=d,c++}}),b}function findAllGrades(){let a=1,b=[];for(;isGradeExist(a);){let c=new Grade;c.id=a,c.type=getGradeType(c.id),c.rawData=getGradeRawData(a),c.rawVal=getGradeRawValue(a),c.val=getGradeValueFromRawValue(c.rawVal),c.subject=getGradeSubject(c.id),c.category=getGradeCategoryFromRawData(c.rawData),c.date=getGradeDateFromRawData(c.rawData),c.weight=getGradeWeightFromRawData(c.rawData),c.teacher=getGradeTeacherFromRawData(c.rawData),c.addedBy=getGradeAddedByFromRawData(c.rawData),b[a-1]=c,DEBUG_GRADES&&(console.debug("id: "+b[a-1].id),console.debug("type: "+b[a-1].type),console.debug("raw data: "+b[a-1].rawData),console.debug("raw val: "+b[a-1].rawVal),console.debug("val: "+b[a-1].val),console.debug("subject: "+b[a-1].subject),console.debug("category: "+b[a-1].category),console.debug("date: "+b[a-1].date),console.debug("weight: "+b[a-1].weight),console.debug("teacher: "+b[a-1].teacher),console.debug("added by: "+b[a-1].addedBy),console.debug("\n\n")),a++}return b}function countGrades(){let a=0,b=1,c=!0;do isGradeExist(b)?(a++,b++):c=!1;while(c);return a}function isGradeExist(a){return null!=$(GRADE_ID+a).html()}function getGradeRawData(a){return $(GRADE_ID+a).children("a").attr(TITLE_ATTRIBUTE).replace(/<br>/g,";").replace(/: /g,":").replace(/<br\/>/g,";")}function getGradeRawValue(a){return $(GRADE_ID+a).children("a").html()}function getGradeType(a){let b=GRADE_NORMAL;return isGradeProposedFromFirstPeriod(a)?b=GRADE_PROPOSED_FIRST:isGradeProposedFromSecondPeriod(a)?b=GRADE_PROPOSED_SECOND:isGradeEndFirst(a)?b=GRADE_END_FIRST:isGradeEndSecond(a)?b=GRADE_END_SECOND:isPlus(getGradeRawValue(a))?b=GRADE_PLUS:isMinus(getGradeRawValue(a))?b=GRADE_MINUS:isGradeUnprepared(a)&&(b=GRADE_UNPREPARED),b}function getGradeValueFromRawValue(a){let b=0;return null!==a&&void 0!=a&&!isPlusOrMinus(a)&&isNumberWithPlusOrMinus(a)&&(b=getConvertedNumberFromRawGradeValue(a)),b}function getGradeSubject(a){let b=null;return b=isGradeProposedFromFirstPeriod(a)?$(GRADE_ID+a).parent().prevAll().eq(2).html():isGradeEndFirst(a)?$(GRADE_ID+a).parent().prevAll().eq(3).html():isGradeProposedFromSecondPeriod(a)?$(GRADE_ID+a).parent().prevAll().eq(2).html():isGradeEndSecond(a)?$(GRADE_ID+a).parent().prevAll().eq(3).html():$(GRADE_ID+a).parent().prev().html()}function getGradeCategoryFromRawData(a){return a.substr(a.indexOf("Kategoria:")+10,100).split(";")[0]}function getGradeDateFromRawData(a){return a.substr(a.indexOf("Data:")+5,10).split(";")[0]}function getGradeTeacherFromRawData(a){return a.substr(a.indexOf("Nauczyciel:")+11,50).split(";")[0]}function getGradeAddedByFromRawData(a){return a.substr(a.indexOf("Dodał:")+6,50).split(";")[0]}function getConvertedNumberFromRawGradeValue(a){return hasPlusOrMinus(a)&&(a.search(/\+/g)!=-1?(a=Number(a.replace(/\+/g,"")),a+=.5):a.search("-")!=-1&&(a=Number(a.replace("-","")),a-=.25)),a}function getGradeWeightFromRawData(a){return isWeightExist(a)?getGradeWeightSubstring(a):0}function getGradeWeightSubstring(a){return a.substr(a.indexOf("Waga:")+5,4).split(";")[0]}function isWeightExist(a){return a.indexOf("Waga:")!==-1}function isNumberWithPlusOrMinus(a){return hasPlusOrMinus(a)&&(a=a.replace(/\+/g,""),a=a.replace("-","")),!isNaN(a)}function isPlusOrMinus(a){return hasPlusOrMinus(a)&&1==a.length}function isPlus(a){return a.search(/\+/g)!=-1&&1==a.length}function isMinus(a){return a.search("-")!=-1&&1==a.length}function hasPlusOrMinus(a){return a.search(/\+/g)!=-1||a.search("-")!=-1}function isGradeProposedFromFirstPeriod(a){return $(GRADE_ID+a).children("a").attr(TITLE_ATTRIBUTE).indexOf(CATEGORY_PROPOSED_FISRT)!==-1}function isGradeProposedFromSecondPeriod(a){return $(GRADE_ID+a).children("a").attr(TITLE_ATTRIBUTE).indexOf(CATEGORY_PROPOSED_SECOND)!==-1}function isGradeEndFirst(a){return $(GRADE_ID+a).children("a").attr(TITLE_ATTRIBUTE).indexOf(CATEGORY_END_FISRT)!==-1}function isGradeEndSecond(a){return $(GRADE_ID+a).children("a").attr(TITLE_ATTRIBUTE).indexOf(CATEGORY_END_SECOND)!==-1}function isGradeUnprepared(a){return $(GRADE_ID+a).children("a").html().indexOf("np")!==-1}function getAllSubjects(a){let b=new Array,c=0;return a.forEach(function(d){if(0==c||0!==b[c-1].name.localeCompare(d.subject)){let e=new Subject;e.id=getIdOfSubjectOfGrade(d.id),e.name=d.subject,e.avg=getAvgOfSubject(e.name,a),b[c]=e,c++}}),b}function getIdOfSubjectOfGrade(a){return $(GRADE_ID+a).parent().parent().next().attr("id").split("_")[1]}function getGradesByDateRange(b,c){let d=new Array,e=0;return a.grades.forEach(function(a){isDateInSelectedRange(a.date,b,c)&&(d[e]=a,e++)}),d}function showDataFromSelectedRange(){let a=$("#dateRageStart").val(),b=$("#dateRageEnd").val(),c=getGradesByDateRange(a,b);displayGradesAndAvg(c);let d=getCalculatedAvg(c);setAvgValueOfDateRangeOnPage(d);let e=getAllSubjects(c);setAvgValueOfSubjectOnPage(e)}function createFormForUserAvgOfDateRage(){$("#"+LIBPLUS_ID).append(STUDENT_AVG_DATE_RAGE_FROM);let a=getDate(),b=getSchoolYearStartDate();$("#dateRageStart").val(b),$("#dateRageEnd").val(a),$("#showDataFromRange").click(function(){showDataFromSelectedRange()})}function isDateInSelectedRange(a,b,c){return!(0!==a.localeCompare(b)&&1!==a.localeCompare(b)||a.localeCompare(c)!==-1&&0!==a.localeCompare(c))}function createButtons(){addUpdateButtonOnPage(),addExportToExcelButtonOnPage()}function addUpdateButtonOnPage(){$(".inside").after('<div id="updateButton"><span class="fold"><a href="#" class="fold-link"><span class="fold-start">Aktualizuj</span><span class="fold-end"></span></a></span></div>'),$("#updateButton").click(function(){updateAll()})}function updateAll(){a=getUserWithData(),calculateAndDisplayAvg(),console.log("updated")}function addExportToExcelButtonOnPage(){$(".inside").after('<div id="exportButton" title="Eksportuj oceny do Excela dzięki rozszerzeniu LibPLUS!"><span class="fold"><a href="#" class="fold-link"><span class="fold-start">Eksportuj</span><span class="fold-end"></span></a></span></div>'),$("#exportButton").click(function(){exportDataToExcel()})}function exportDataToExcel(){let b=new ExcelPlus;b.createFile("Oceny").write({content:[["ID","PRZEDMIOT","NAUCZYCIEL","DATA","KATEGORIA","TYP","DODANE PRZEZ","RAW","OCENA","WAGA"]]});let c=2;a.grades.forEach(function(a){let d=Number(a.weight);b.write({cell:"A"+c,content:a.id}).write({cell:"B"+c,content:a.subject}).write({cell:"C"+c,content:a.teacher}).write({cell:"D"+c,content:a.date}).write({cell:"E"+c,content:a.category}).write({cell:"F"+c,content:a.type}).write({cell:"G"+c,content:a.addedBy}).write({cell:"H"+c,content:a.rawVal}).write({cell:"I"+c,content:0===a.val?"0":Number(a.val)}).write({cell:"J"+c,content:""+Number(d)}),c++});let d=a.name+"LibPLUS-"+(new Date).getTime()+".xlsx";d=d.replace(/\u00a0| /g,"_"),b.saveAs(d),console.log("Generated file: "+d)}function roundDecimalPlaces(a){return a.toFixed(DISPLAY_PRECISION_FLOAT_NUMBER)}function isAllGradeMode(){return 0==$("#zmiany_logowanie_wszystkie").length}function getDate(a){void 0===a&&(a=new Date);let b=a.getFullYear(),c=a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1,d=a.getDate()<10?"0"+a.getDate():a.getDate();return b+"-"+c+"-"+d}function getSchoolYearStartDate(){let a=new Date;return getDate(a.getMonth()+1<9?new Date(a.getFullYear()-1+"-09-01"):new Date(a.getFullYear()+"-09-01"))}window.onload=function(){main()};let a=new User;